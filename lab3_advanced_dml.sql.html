<html>
<head>
<title>lab3_advanced_dml.sql</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #2aacb8;}
.s5 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
lab3_advanced_dml.sql</font>
</center></td></tr></table>
<pre><span class="s0">/* part A */</span>
<span class="s2">DROP DATABASE IF EXISTS </span><span class="s1">advanced_lab</span><span class="s3">;</span>
<span class="s2">CREATE DATABASE </span><span class="s1">advanced_lab</span><span class="s3">;</span>


<span class="s2">DROP TABLE IF EXISTS </span><span class="s1">employees</span><span class="s3">;</span>
<span class="s2">CREATE TABLE </span><span class="s1">employees </span><span class="s3">(</span>
    <span class="s1">emp_id </span><span class="s2">SERIAL PRIMARY KEY</span><span class="s3">,</span>
    <span class="s1">first_name </span><span class="s2">VARCHAR</span><span class="s3">(</span><span class="s4">50</span><span class="s3">),</span>
    <span class="s1">last_name </span><span class="s2">VARCHAR</span><span class="s3">(</span><span class="s4">50</span><span class="s3">),</span>
    <span class="s1">department </span><span class="s2">VARCHAR</span><span class="s3">(</span><span class="s4">50</span><span class="s3">),</span>
    <span class="s1">salary </span><span class="s2">INT DEFAULT </span><span class="s4">40000</span><span class="s3">,</span>
    <span class="s1">hire_date </span><span class="s2">DATE</span><span class="s3">,</span>
    <span class="s2">status VARCHAR</span><span class="s3">(</span><span class="s4">20</span><span class="s3">) </span><span class="s2">DEFAULT </span><span class="s5">'Active'</span>
<span class="s3">);</span>

<span class="s2">DROP TABLE IF EXISTS </span><span class="s1">departments</span><span class="s3">;</span>
<span class="s2">CREATE TABLE </span><span class="s1">departments </span><span class="s3">(</span>
    <span class="s1">dept_id </span><span class="s2">SERIAL PRIMARY KEY</span><span class="s3">,</span>
    <span class="s1">dept_name </span><span class="s2">VARCHAR</span><span class="s3">(</span><span class="s4">50</span><span class="s3">),</span>
    <span class="s1">budget </span><span class="s2">INT</span><span class="s3">,</span>
    <span class="s1">manager_id </span><span class="s2">INT</span>
<span class="s3">);</span>

<span class="s2">DROP TABLE IF EXISTS </span><span class="s1">projects</span><span class="s3">;</span>
<span class="s2">CREATE TABLE </span><span class="s1">projects </span><span class="s3">(</span>
    <span class="s1">project_id </span><span class="s2">SERIAL PRIMARY KEY</span><span class="s3">,</span>
    <span class="s1">project_name </span><span class="s2">VARCHAR</span><span class="s3">(</span><span class="s4">100</span><span class="s3">),</span>
    <span class="s1">dept_id </span><span class="s2">INT</span><span class="s3">,</span>
    <span class="s1">start_date </span><span class="s2">DATE</span><span class="s3">,</span>
    <span class="s1">end_date </span><span class="s2">DATE</span><span class="s3">,</span>
    <span class="s1">budget </span><span class="s2">INT</span>
<span class="s3">);</span>

<span class="s0">/* part B */</span>
<span class="s2">INSERT INTO </span><span class="s1">employees </span><span class="s3">(</span><span class="s1">first_name</span><span class="s3">, </span><span class="s1">last_name</span><span class="s3">, </span><span class="s1">department</span><span class="s3">)</span>
<span class="s2">VALUES </span><span class="s3">(</span><span class="s5">'Aru'</span><span class="s3">, </span><span class="s5">'Ngz'</span><span class="s3">, </span><span class="s5">'HR'</span><span class="s3">);</span>

<span class="s2">INSERT INTO </span><span class="s1">employees </span><span class="s3">(</span><span class="s1">first_name</span><span class="s3">, </span><span class="s1">last_name</span><span class="s3">, </span><span class="s1">department</span><span class="s3">, </span><span class="s1">salary</span><span class="s3">, </span><span class="s2">status</span><span class="s3">)</span>
<span class="s2">VALUES </span><span class="s3">(</span><span class="s5">'Rau'</span><span class="s3">, </span><span class="s5">'Ord'</span><span class="s3">, </span><span class="s5">'Finance'</span><span class="s3">, </span><span class="s2">DEFAULT</span><span class="s3">, </span><span class="s2">DEFAULT</span><span class="s3">);</span>

<span class="s2">INSERT INTO </span><span class="s1">employees </span><span class="s3">(</span><span class="s1">first_name</span><span class="s3">, </span><span class="s1">last_name</span><span class="s3">, </span><span class="s1">department</span><span class="s3">,  </span><span class="s1">salary</span><span class="s3">,  </span><span class="s1">hire_date</span><span class="s3">)</span>
<span class="s2">VALUES </span><span class="s3">(</span><span class="s5">'Bulat'</span><span class="s3">, </span><span class="s5">'Ass'</span><span class="s3">, </span><span class="s5">'IT'</span><span class="s3">, </span><span class="s4">50000 </span><span class="s1">* </span><span class="s4">1.1</span><span class="s3">, </span><span class="s2">CURRENT_DATE</span><span class="s3">);</span>

<span class="s2">INSERT INTO </span><span class="s1">departments </span><span class="s3">(</span><span class="s1">dept_name</span><span class="s3">, </span><span class="s1">budget</span><span class="s3">, </span><span class="s1">manager_id</span><span class="s3">)</span>
<span class="s2">VALUES</span>
    <span class="s3">(</span><span class="s5">'IT'</span><span class="s3">, </span><span class="s4">200000</span><span class="s3">, </span><span class="s4">1</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s5">'HR'</span><span class="s3">, </span><span class="s4">150000</span><span class="s3">, </span><span class="s4">2</span><span class="s3">),</span>
    <span class="s3">(</span><span class="s5">'Finance'</span><span class="s3">, </span><span class="s4">300000</span><span class="s3">, </span><span class="s4">3</span><span class="s3">);</span>

<span class="s2">DROP TABLE IF EXISTS </span><span class="s1">temp_employees</span><span class="s3">;</span>
<span class="s2">CREATE TEMPORARY TABLE </span><span class="s1">temp_employees </span><span class="s2">AS</span>
<span class="s2">SELECT </span><span class="s1">* </span><span class="s2">FROM </span><span class="s1">employees </span><span class="s2">WHERE </span><span class="s1">department = </span><span class="s5">'IT'</span><span class="s3">;</span>


<span class="s0">/* part C */</span>
<span class="s2">UPDATE </span><span class="s1">employees </span><span class="s2">SET </span><span class="s1">salary = salary * </span><span class="s4">1.10 </span><span class="s2">WHERE status </span><span class="s1">= </span><span class="s5">'Active'</span><span class="s3">;</span>

<span class="s2">UPDATE </span><span class="s1">employees </span><span class="s2">SET status </span><span class="s1">= </span><span class="s5">'Senior'</span>
<span class="s2">WHERE </span><span class="s1">salary &gt; </span><span class="s4">60000 </span><span class="s2">AND </span><span class="s1">hire_date &lt; </span><span class="s5">'2020-01-01'</span><span class="s3">;</span>

<span class="s2">UPDATE </span><span class="s1">employees </span><span class="s2">SET </span><span class="s1">department = </span><span class="s2">CASE</span>
<span class="s2">WHEN </span><span class="s1">salary &gt; </span><span class="s4">80000 </span><span class="s2">THEN </span><span class="s5">'Management'</span>
<span class="s2">WHEN </span><span class="s1">salary </span><span class="s2">BETWEEN </span><span class="s4">50000 </span><span class="s2">AND </span><span class="s4">80000 </span><span class="s2">THEN </span><span class="s5">'Senior'</span>
<span class="s2">ELSE </span><span class="s5">'Junior' </span><span class="s2">END WHERE status </span><span class="s1">= </span><span class="s5">'Active'</span><span class="s3">;;</span>

<span class="s2">UPDATE </span><span class="s1">employees</span>
<span class="s2">SET </span><span class="s1">department = </span><span class="s2">DEFAULT</span>
<span class="s2">WHERE status </span><span class="s1">= </span><span class="s5">'Inactive'</span><span class="s3">;</span>

<span class="s2">UPDATE </span><span class="s1">departments d</span>
<span class="s2">SET </span><span class="s1">budget = sub</span><span class="s3">.</span><span class="s1">avg_salary * </span><span class="s4">1.2</span>
<span class="s2">FROM </span><span class="s3">(</span>
    <span class="s2">SELECT </span><span class="s1">department</span><span class="s3">, </span><span class="s1">AVG</span><span class="s3">(</span><span class="s1">salary</span><span class="s3">) </span><span class="s2">AS </span><span class="s1">avg_salary</span>
    <span class="s2">FROM </span><span class="s1">employees</span>
    <span class="s2">GROUP BY </span><span class="s1">department</span>
<span class="s3">) </span><span class="s1">sub</span>
<span class="s2">WHERE </span><span class="s1">d</span><span class="s3">.</span><span class="s1">dept_name = sub</span><span class="s3">.</span><span class="s1">department</span><span class="s3">;</span>

<span class="s2">UPDATE </span><span class="s1">employees </span><span class="s2">SET </span><span class="s1">salary = salary * </span><span class="s4">1.15</span><span class="s3">, </span><span class="s2">status </span><span class="s1">= </span><span class="s5">'Promoted'</span>
<span class="s2">WHERE </span><span class="s1">department = </span><span class="s5">'Sales'</span><span class="s3">;</span>

<span class="s0">-- part D --</span>

<span class="s2">DELETE FROM </span><span class="s1">employees </span><span class="s2">WHERE status </span><span class="s1">= </span><span class="s5">'Terminated'</span><span class="s3">;</span>

<span class="s2">DELETE FROM </span><span class="s1">employees </span><span class="s2">WHERE </span><span class="s1">salary &lt; </span><span class="s4">40000 </span><span class="s2">AND </span><span class="s1">hire_date &gt; </span><span class="s5">'2023-01-01' </span><span class="s2">AND  </span><span class="s1">department </span><span class="s2">IS NULL</span><span class="s3">;</span>

<span class="s2">DELETE FROM </span><span class="s1">departments </span><span class="s2">WHERE </span><span class="s1">dept_id </span><span class="s2">NOT IN </span><span class="s3">(</span><span class="s2">SELECT DISTINCT </span><span class="s1">d</span><span class="s3">.</span><span class="s1">dept_id </span><span class="s2">FROM </span><span class="s1">departments d </span><span class="s2">JOIN </span><span class="s1">employees e </span><span class="s2">ON </span><span class="s1">e</span><span class="s3">.</span><span class="s1">department = d</span><span class="s3">.</span><span class="s1">dept_name</span>
<span class="s2">WHERE </span><span class="s1">e</span><span class="s3">.</span><span class="s1">department </span><span class="s2">IS NOT NULL</span><span class="s3">);</span>

<span class="s2">DELETE FROM </span><span class="s1">projects </span><span class="s2">WHERE </span><span class="s1">end_date &lt; </span><span class="s5">'2023-01-01' </span><span class="s2">RETURNING </span><span class="s1">*</span><span class="s3">;</span>

<span class="s0">-- part E</span>

<span class="s2">INSERT INTO </span><span class="s1">employees </span><span class="s3">(</span><span class="s1">first_name</span><span class="s3">, </span><span class="s1">last_name</span><span class="s3">, </span><span class="s1">salary</span><span class="s3">, </span><span class="s1">department</span><span class="s3">, </span><span class="s1">hire_date</span><span class="s3">)</span>
<span class="s2">VALUES </span><span class="s3">(</span><span class="s5">'Null'</span><span class="s3">, </span><span class="s5">'Tester'</span><span class="s3">, </span><span class="s2">NULL</span><span class="s3">, </span><span class="s2">NULL</span><span class="s3">, </span><span class="s2">CURRENT_DATE</span><span class="s3">);</span>

<span class="s2">UPDATE </span><span class="s1">employees</span>
<span class="s2">SET </span><span class="s1">department = </span><span class="s5">'Unassigned' </span><span class="s2">WHERE </span><span class="s1">department </span><span class="s2">IS NULL</span><span class="s3">;</span>

<span class="s2">DELETE FROM </span><span class="s1">employees</span>
<span class="s2">WHERE </span><span class="s1">salary </span><span class="s2">IS NULL OR </span><span class="s1">department </span><span class="s2">IS NULL</span><span class="s3">;</span>

<span class="s0">-- part E</span>

<span class="s2">INSERT INTO </span><span class="s1">employees </span><span class="s3">(</span><span class="s1">first_name</span><span class="s3">, </span><span class="s1">last_name</span><span class="s3">, </span><span class="s1">department</span><span class="s3">, </span><span class="s1">salary</span><span class="s3">, </span><span class="s1">hire_date</span><span class="s3">)</span>
<span class="s2">VALUES </span><span class="s3">(</span><span class="s5">'Return'</span><span class="s3">, </span><span class="s5">'Example'</span><span class="s3">, </span><span class="s5">'IT'</span><span class="s3">, </span><span class="s4">60000</span><span class="s3">, </span><span class="s2">CURRENT_DATE</span><span class="s3">)</span>
<span class="s2">RETURNING </span><span class="s1">emp_id</span><span class="s3">, (</span><span class="s1">first_name || </span><span class="s5">' ' </span><span class="s1">|| last_name</span><span class="s3">) </span><span class="s2">AS </span><span class="s1">full_name</span><span class="s3">;</span>

<span class="s2">UPDATE </span><span class="s1">employees</span>
<span class="s2">SET </span><span class="s1">salary = salary + </span><span class="s4">5000</span>
<span class="s2">WHERE </span><span class="s1">department = </span><span class="s5">'IT'</span>
<span class="s2">RETURNING </span><span class="s1">emp_id</span><span class="s3">, </span><span class="s1">salary - </span><span class="s4">5000 </span><span class="s2">AS </span><span class="s1">old_salary</span><span class="s3">, </span><span class="s1">salary </span><span class="s2">AS </span><span class="s1">new_salary</span><span class="s3">;</span>

<span class="s2">DELETE FROM </span><span class="s1">employees</span>
<span class="s2">WHERE </span><span class="s1">hire_date &lt; </span><span class="s5">'2020-01-01'</span>
<span class="s2">RETURNING </span><span class="s1">*</span><span class="s3">;</span>

<span class="s0">-- part G</span>


<span class="s2">INSERT INTO </span><span class="s1">employees </span><span class="s3">(</span><span class="s1">first_name</span><span class="s3">, </span><span class="s1">last_name</span><span class="s3">, </span><span class="s1">department</span><span class="s3">, </span><span class="s1">salary</span><span class="s3">, </span><span class="s1">hire_date</span><span class="s3">)</span>
<span class="s2">SELECT </span><span class="s5">'Unique'</span><span class="s3">, </span><span class="s5">'Person'</span><span class="s3">, </span><span class="s5">'IT'</span><span class="s3">, </span><span class="s4">50000</span><span class="s3">, </span><span class="s2">CURRENT_DATE</span>
<span class="s2">WHERE NOT EXISTS </span><span class="s3">(</span>
    <span class="s2">SELECT </span><span class="s4">1 </span><span class="s2">FROM </span><span class="s1">employees</span>
    <span class="s2">WHERE </span><span class="s1">first_name = </span><span class="s5">'Unique' </span><span class="s2">AND </span><span class="s1">last_name = </span><span class="s5">'Person'</span>
<span class="s3">);</span>


<span class="s2">UPDATE </span><span class="s1">employees e</span>
<span class="s2">SET </span><span class="s1">salary = salary * </span><span class="s2">CASE</span>
    <span class="s2">WHEN </span><span class="s1">d</span><span class="s3">.</span><span class="s1">budget &gt; </span><span class="s4">100000 </span><span class="s2">THEN </span><span class="s4">1.10</span>
    <span class="s2">ELSE </span><span class="s4">1.05</span>
<span class="s2">END</span>
<span class="s2">FROM </span><span class="s1">departments d</span>
<span class="s2">WHERE </span><span class="s1">e</span><span class="s3">.</span><span class="s1">department = d</span><span class="s3">.</span><span class="s1">dept_name</span><span class="s3">;</span>


<span class="s2">INSERT INTO </span><span class="s1">employees </span><span class="s3">(</span><span class="s1">first_name</span><span class="s3">, </span><span class="s1">last_name</span><span class="s3">, </span><span class="s1">department</span><span class="s3">, </span><span class="s1">salary</span><span class="s3">, </span><span class="s1">hire_date</span><span class="s3">)</span>
<span class="s2">VALUES</span>
<span class="s3">(</span><span class="s5">'Bulk1'</span><span class="s3">, </span><span class="s5">'Emp'</span><span class="s3">, </span><span class="s5">'Sales'</span><span class="s3">, </span><span class="s4">40000</span><span class="s3">, </span><span class="s2">CURRENT_DATE</span><span class="s3">),</span>
<span class="s3">(</span><span class="s5">'Bulk2'</span><span class="s3">, </span><span class="s5">'Emp'</span><span class="s3">, </span><span class="s5">'Sales'</span><span class="s3">, </span><span class="s4">42000</span><span class="s3">, </span><span class="s2">CURRENT_DATE</span><span class="s3">),</span>
<span class="s3">(</span><span class="s5">'Bulk3'</span><span class="s3">, </span><span class="s5">'Emp'</span><span class="s3">, </span><span class="s5">'Sales'</span><span class="s3">, </span><span class="s4">45000</span><span class="s3">, </span><span class="s2">CURRENT_DATE</span><span class="s3">),</span>
<span class="s3">(</span><span class="s5">'Bulk4'</span><span class="s3">, </span><span class="s5">'Emp'</span><span class="s3">, </span><span class="s5">'Sales'</span><span class="s3">, </span><span class="s4">47000</span><span class="s3">, </span><span class="s2">CURRENT_DATE</span><span class="s3">),</span>
<span class="s3">(</span><span class="s5">'Bulk5'</span><span class="s3">, </span><span class="s5">'Emp'</span><span class="s3">, </span><span class="s5">'Sales'</span><span class="s3">, </span><span class="s4">49000</span><span class="s3">, </span><span class="s2">CURRENT_DATE</span><span class="s3">);</span>

<span class="s2">UPDATE </span><span class="s1">employees</span>
<span class="s2">SET </span><span class="s1">salary = salary * </span><span class="s4">1.10</span>
<span class="s2">WHERE </span><span class="s1">last_name = </span><span class="s5">'Emp' </span><span class="s2">AND </span><span class="s1">first_name </span><span class="s2">LIKE </span><span class="s5">'Bulk%'</span><span class="s3">;</span>


<span class="s2">CREATE TABLE IF NOT EXISTS </span><span class="s1">employee_archive </span><span class="s2">AS</span>
<span class="s2">TABLE </span><span class="s1">employees </span><span class="s2">WITH NO DATA</span><span class="s3">;</span>

<span class="s2">INSERT INTO </span><span class="s1">employee_archive</span>
<span class="s2">SELECT </span><span class="s1">* </span><span class="s2">FROM </span><span class="s1">employees</span>
<span class="s2">WHERE status </span><span class="s1">= </span><span class="s5">'Inactive'</span><span class="s3">;</span>

<span class="s2">DELETE FROM </span><span class="s1">employees</span>
<span class="s2">WHERE status </span><span class="s1">= </span><span class="s5">'Inactive'</span><span class="s3">;</span>


<span class="s2">UPDATE </span><span class="s1">projects p</span>
<span class="s2">SET </span><span class="s1">end_date = end_date + </span><span class="s2">INTERVAL </span><span class="s5">'30 days'</span>
<span class="s2">WHERE </span><span class="s1">p</span><span class="s3">.</span><span class="s1">budget &gt; </span><span class="s4">50000</span>
  <span class="s2">AND </span><span class="s3">(</span>
      <span class="s2">SELECT </span><span class="s1">COUNT</span><span class="s3">(</span><span class="s1">*</span><span class="s3">)</span>
      <span class="s2">FROM </span><span class="s1">employees e</span>
      <span class="s2">WHERE </span><span class="s1">e</span><span class="s3">.</span><span class="s1">department = </span><span class="s3">(</span>
          <span class="s2">SELECT </span><span class="s1">dept_name </span><span class="s2">FROM </span><span class="s1">departments d </span><span class="s2">WHERE </span><span class="s1">d</span><span class="s3">.</span><span class="s1">dept_id = p</span><span class="s3">.</span><span class="s1">dept_id</span>
      <span class="s3">)</span>
  <span class="s3">) </span><span class="s1">&gt; </span><span class="s4">3</span><span class="s3">;</span>


</pre>
</body>
</html>